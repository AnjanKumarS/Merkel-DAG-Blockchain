<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAG Visualization | Blockchain Simulation</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .graph-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .graph-image {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .graph-image:hover {
            transform: scale(1.02);
        }

        .stats-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
        }

        .tip-node {
            background: linear-gradient(135deg, #FF6B35 0%, #F7931E 100%);
            color: white;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }

        .confirmed-node {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
            color: white;
            border-radius: 8px;
            padding: 10px;
            margin: 5px 0;
        }

        .dag-container {
            width: 100%;
            height: 600px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }

        .node {
            stroke: #fff;
            stroke-width: 2px;
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .node-label {
            font-family: monospace;
            font-size: 12px;
            font-weight: bold;
            fill: #333;
        }

        .link-label {
            font-family: monospace;
            font-size: 10px;
            fill: #666;
        }
    </style>
</head>

<body data-bs-theme="dark">
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Blockchain Simulation</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/blockchain">Blockchain</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dag">DAG</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/transactions">Transactions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/wallets">Wallets</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">{{ message }}</div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <h1 class="mb-4 text-center">DAG Visualization - Interactive Graph Structure</h1>

        <!-- Graph Statistics -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <h4>{{ dag_data.stats.transaction_count }}</h4>
                    <p class="mb-0">Total Transactions</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <h4>{{ dag_data.stats.tip_count }}</h4>
                    <p class="mb-0">Active Tips</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card text-center">
                    <h4>{{ dag_data.stats.edge_count }}</h4>
                    <p class="mb-0">Graph Edges</p>
                </div>
            </div>
        </div>

        <!-- Interactive DAG Graph Visualization -->
        <div class="row">
            <div class="col-md-12">
                <div class="graph-container">
                    <h3 class="text-center text-white mb-4">Interactive DAG Graph Structure</h3>
                    <div class="dag-container">
                        <svg width="100%" height="100%" id="dag"></svg>
                    </div>
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="tip-node">
                                <h6><i class="fas fa-exclamation-triangle"></i> Tips (Unconfirmed)</h6>
                                <p class="mb-0">Orange nodes represent unconfirmed transactions waiting for approval</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="confirmed-node">
                                <h6><i class="fas fa-check-circle"></i> Confirmed</h6>
                                <p class="mb-0">Teal nodes represent confirmed transactions in the DAG</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DAG Explanation -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">Interactive DAG Graph Structure</h4>
                    </div>
                    <div class="card-body">
                        <p>
                            This <strong>interactive DAG visualization</strong> shows the actual connections between
                            transactions
                            in the Directed Acyclic Graph. You can drag nodes to explore the structure and see how
                            transactions
                            reference each other.
                        </p>
                        <div class="row">
                            <div class="col-md-6">
                                <h5>Interactive Features:</h5>
                                <ul>
                                    <li><strong>Drag Nodes:</strong> Click and drag nodes to reposition them</li>
                                    <li><strong>Force Layout:</strong> Nodes automatically arrange based on connections
                                    </li>
                                    <li><strong>Real Connections:</strong> Lines show actual transaction references</li>
                                    <li><strong>Dynamic:</strong> Graph updates as new transactions are added</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h5>Graph Elements:</h5>
                                <ul>
                                    <li><strong>Nodes:</strong> Individual transactions with unique hashes</li>
                                    <li><strong>Edges:</strong> Direct references between transactions</li>
                                    <li><strong>Colors:</strong> Orange for tips, Teal for confirmed</li>
                                    <li><strong>Labels:</strong> Show transaction hash prefixes</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Tables -->
        <div class="row">
            <div class="col-md-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">DAG Transactions</h4>
                    </div>
                    <div class="card-body">
                        <h5>Current Tips (Unconfirmed Transactions)</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Hash (first 10 chars)</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Amount</th>
                                        <th>Weight</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tip in dag_data.tips %}
                                    <tr>
                                        <td><code>{{ tip.hash[:10] }}...</code></td>
                                        <td>{{ tip.transaction.sender }}</td>
                                        <td>{{ tip.transaction.recipient }}</td>
                                        <td>{{ tip.transaction.amount }}</td>
                                        <td>{{ tip.weight }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="5" class="text-center">No tips available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <h5 class="mt-4">All Transactions in DAG</h5>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Hash (first 10 chars)</th>
                                        <th>From</th>
                                        <th>To</th>
                                        <th>Amount</th>
                                        <th>Weight</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for tx in dag_data.transactions %}
                                    <tr>
                                        <td><code>{{ tx.hash[:10] }}...</code></td>
                                        <td>{{ tx.transaction.sender }}</td>
                                        <td>{{ tx.transaction.recipient }}</td>
                                        <td>{{ tx.transaction.amount }}</td>
                                        <td>{{ tx.weight }}</td>
                                        <td>
                                            {% if tx.is_tip %}
                                            <span class="badge bg-warning text-dark">Tip</span>
                                            {% else %}
                                            <span class="badge bg-success">Confirmed</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center">No transactions available</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-12 text-center">
                    <p>DAG-based Merkle Tree Transaction System</p>
                    <p class="text-muted">A Python-based Blockchain Simulation</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
        async function fetchDAGData() {
            try {
                const response = await fetch('/api/dag_graph');
                const dagData = await response.json();

                if (response.ok) {
                    renderDAG(dagData);
                } else {
                    console.error('Failed to load DAG data:', dagData.error);
                }
            } catch (error) {
                console.error('Error fetching DAG data:', error);
            }
        }

        function renderDAG(data) {
            const container = document.querySelector('.dag-container');
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select("#dag")
                .attr("width", width)
                .attr("height", height);

            // Clear previous DAG
            svg.selectAll("*").remove();

            // Create nodes from transactions
            const nodes = data.nodes.map(node => ({
                id: node.id,
                hash: node.hash,
                is_tip: node.is_tip,
                weight: node.weight,
                sender: node.sender,
                recipient: node.recipient,
                amount: node.amount
            }));

            // Create links from edges
            const links = data.edges.map(edge => ({
                source: edge.source,
                target: edge.target,
                amount: edge.amount
            }));

            // Setup force simulation
            const simulation = d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id).distance(150))
                .force("charge", d3.forceManyBody().strength(-800))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(30))
                .alphaDecay(0.05);

            // Create arrow marker
            svg.append("defs").append("marker")
                .attr("id", "arrowhead")
                .attr("viewBox", "0 -5 10 10")
                .attr("refX", 20)
                .attr("refY", 0)
                .attr("markerWidth", 6)
                .attr("markerHeight", 6)
                .attr("orient", "auto")
                .append("path")
                .attr("d", "M0,-5L10,0L0,5")
                .attr("fill", "#999");

            // Draw links
            const link = svg.selectAll(".link")
                .data(links)
                .enter().append("line")
                .attr("class", "link")
                .attr("marker-end", "url(#arrowhead)")
                .attr("stroke-width", d => Math.max(1, Math.sqrt(d.amount || 1)));

            // Draw nodes
            const node = svg.selectAll(".node")
                .data(nodes)
                .enter().append("circle")
                .attr("class", "node")
                .attr("r", d => Math.max(15, Math.sqrt(d.weight || 1) * 3))
                .attr("fill", d => d.is_tip ? "#FF6B35" : "#4ECDC4")
                .call(drag(simulation));

            // Draw node labels
            const label = svg.selectAll(".node-label")
                .data(nodes)
                .enter().append("text")
                .attr("class", "node-label")
                .attr("dy", -25)
                .attr("text-anchor", "middle")
                .text(d => d.hash.substring(0, 8) + "...")
                .attr("font-size", "10px");

            // Draw link labels (amounts)
            const linkLabel = svg.selectAll(".link-label")
                .data(links)
                .enter().append("text")
                .attr("class", "link-label")
                .attr("text-anchor", "middle")
                .text(d => d.amount ? d.amount.toFixed(2) : "")
                .attr("font-size", "8px");

            // Update simulation positions
            simulation.on("tick", () => {
                link
                    .attr("x1", d => d.source.x)
                    .attr("y1", d => d.source.y)
                    .attr("x2", d => d.target.x)
                    .attr("y2", d => d.target.y);

                node
                    .attr("cx", d => d.x)
                    .attr("cy", d => d.y);

                label
                    .attr("x", d => d.x)
                    .attr("y", d => d.y);

                linkLabel
                    .attr("x", d => (d.source.x + d.target.x) / 2)
                    .attr("y", d => (d.source.y + d.target.y) / 2);
            });

            // Drag function
            function drag(simulation) {
                return d3.drag()
                    .on("start", (event, d) => {
                        if (!event.active) simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on("drag", (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on("end", (event, d) => {
                        if (!event.active) simulation.alphaTarget(0);
                        d.fx = null;
                        d.fy = null;
                    });
            }
        }

        // Load DAG data on page load
        fetchDAGData();

        // Refresh DAG data every 5 seconds
        setInterval(fetchDAGData, 5000);
    </script>
</body>

</html>